# PHP 8.3アップグレード - 船データフォーマット拡張ガイド

## 概要

PHP 8.3対応に伴い、船データのフォーマットを拡張しました。
島IDの上限を31から1023に拡張するため、ビット配分を変更しています。

### 変更内容

**旧フォーマット（20ビット）**:
- 5ビット：島ID（0-31）
- 3ビット：船の種類
- 4ビット：耐久力
- 4ビット：経験値
- 4ビット：フラグ

**新フォーマット（25ビット）**:
- 10ビット：島ID（0-1023）
- 3ビット：船の種類
- 4ビット：耐久力
- 4ビット：経験値
- 4ビット：フラグ

## データ移行について

**データ移行スクリプトは不要です！**

新しい実装では、**旧フォーマットと新フォーマットの両方を自動判別**して処理します。

### 動作の仕組み

1. **読み込み時（`navyUnpack()`）**:
   - 旧フォーマット（5ビット島ID）と新フォーマット（10ビット島ID）の両方を自動判別
   - ビット20以降に値があれば新フォーマット、なければ旧フォーマットとして処理

2. **保存時（`navyPack()`）**:
   - 常に新フォーマット（10ビット島ID）で保存
   - 島IDの上限：1023（旧フォーマットでは31まで）

3. **段階的移行**:
   - 既存の船データは旧フォーマットのまま正常に読み込まれる
   - 船が移動・更新されるたびに、自動的に新フォーマットで保存される
   - データ変換スクリプト不要で、段階的に新フォーマットへ移行

## アップグレード手順

### 1. コードの更新

```bash
cd /home/kusanagi/webrara/DocumentRoot/hakoniwa
git pull origin claude/php-8.3-upgrade-01YSBgyMsCwXK1KKEVz8FS9j
```

### 2. PHP-FPMの再起動

```bash
sudo systemctl restart php-fpm
# または
sudo systemctl restart php7-fpm
```

### 3. 動作確認

ブラウザでゲームにアクセスし、正常に動作することを確認してください。

## 安全性について

### データ破損のリスクなし

- **既存データは一切変更されません**
- バックアップ不要（推奨はしますが必須ではありません）
- データ変換スクリプト不要
- ロールバックも容易（コードを元に戻すだけ）

### 互換性の保証

- 旧フォーマットのデータは正常に読み込まれます
- 新フォーマットのデータも正常に読み込まれます
- 旧フォーマットと新フォーマットが混在しても問題ありません

### 段階的移行

船が更新されるたびに、自動的に新フォーマットへ移行されます：

- 船が移動する
- 船が攻撃を受ける
- 船の耐久力が変わる
- 船が財宝を拾う

など、船データが更新される操作で自動的に新フォーマットになります。

## トラブルシューティング

### エラー: 船籍ID不正: ID=XXX, max=1023

島IDが1023を超えています。この場合は、さらにビット配分の変更が必要です。

### 既存の船が正常に動作しない

旧フォーマットと新フォーマットの自動判別が正しく動作していない可能性があります。
エラーメッセージを確認してください。

## 技術詳細

### フォーマット判別ロジック

```php
// navyUnpack()での判別処理
$lv = /* 船データ */;

// 下位15ビット（flag, exp, hp, kind）を取り除く
$lv >>= 15;

// 残りビット（島ID部分）をチェック
if (($lv >> 5) > 0) {
    // ビット5以降に値がある → 新フォーマット（10ビット島ID）
    $id = $lv & 0x3ff;  // 10ビット取得
} else {
    // ビット5以降に値がない → 旧フォーマット（5ビット島ID）
    $id = $lv & 0x1f;   // 5ビット取得
}
```

### 保存時の処理

```php
// navyPack()は常に新フォーマット（10ビット島ID）で保存
$lv = 0;
$lv |= $id & 0x3ff;  // 10ビット島ID
$lv <<= 3;
$lv |= $kind & 0x07;
$lv <<= 4;
$lv |= $hp & 0x0f;
$lv <<= 4;
$lv |= $exp & 0x0f;
$lv <<= 4;
$lv |= $flag & 0x0f;
```

## まとめ

- ✅ データ移行スクリプト不要
- ✅ 既存データはそのまま使用可能
- ✅ 新旧フォーマット混在OK
- ✅ 段階的に新フォーマットへ移行
- ✅ データ破損リスクなし
- ✅ バックアップ必須ではない（推奨はします）
- ✅ ロールバックが容易

安心してアップグレードしてください！
