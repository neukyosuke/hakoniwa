# PHP 8.3アップグレード - 船データ移行ガイド

## 概要

PHP 8.3対応に伴い、船データのフォーマットを変更しました。
島IDの上限を31から1023に拡張するため、ビット配分を変更しています。

### 変更内容

**旧フォーマット（20ビット）**:
- 5ビット：島ID（0-31）
- 3ビット：船の種類
- 4ビット：耐久力
- 4ビット：経験値
- 4ビット：フラグ

**新フォーマット（25ビット）**:
- 10ビット：島ID（0-1023）
- 3ビット：船の種類
- 4ビット：耐久力
- 4ビット：経験値
- 4ビット：フラグ

## 移行が必要な理由

現在、`islandNextID`が275まで進んでおり、旧フォーマットの島ID上限（31）を超えています。
新しい島が作成されるとエラーが発生するため、データ移行が必要です。

## 移行手順

### 1. バックアップの作成

```bash
cd /home/kusanagi/webrara/DocumentRoot/hakoniwa
cp -r neulogs neulogs.backup
```

### 2. コードの更新

```bash
git pull origin claude/php-8.3-upgrade-01YSBgyMsCwXK1KKEVz8FS9j
```

### 3. 移行スクリプトの実行

```bash
php migrate_ship_data.php
```

実行すると以下のような出力が表示されます：

```
=== 船データ移行スクリプト ===
旧フォーマット（5ビット島ID）→ 新フォーマット（10ビット島ID）

データファイル読み込み中...
ターン: 269
島の数: 28
次の島ID: 47

島ファイルを変換中...
island.6: 3 隻の船データを変換
island.51: 2 隻の船データを変換
...

変換完了: 合計 15 隻

成功！船データの移行が完了しました。
```

### 4. 動作確認

ブラウザでゲームにアクセスし、正常に動作することを確認してください。

## ロールバック方法

問題が発生した場合、以下の手順でロールバックできます：

```bash
# バックアップから復元
rm -rf neulogs
cp -r neulogs.backup neulogs

# 旧バージョンのコードに戻す
git checkout <前のコミットID>
```

## トラブルシューティング

### エラー: 船籍ID不正: ID=XXX, max=1023

島IDが1023を超えています。この場合は、さらにビット配分の変更が必要です。

### 変換された船データが0隻

- 現在、船が存在しない可能性があります（正常）
- 既に新フォーマットに変換済みの可能性があります
- データファイルの読み込みに失敗している可能性があります

### ファイルが見つかりません

`config.php`で正しいデータディレクトリが設定されているか確認してください。

## 注意事項

- **必ずバックアップを取ってから実行してください**
- 移行スクリプトは1度だけ実行してください（2回実行するとデータが壊れます）
- 移行中はゲームへのアクセスを停止してください
- PHP-FPMを再起動してキャッシュをクリアしてください

```bash
sudo systemctl restart php-fpm
```
